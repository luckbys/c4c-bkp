const { initializeApp } = require('firebase/app');
const { getFirestore, collection, getDocs, query, where, orderBy, limit } = require('firebase/firestore');
require('dotenv').config({ path: '.env.local' });

// Configura√ß√£o do Firebase
const firebaseConfig = {
  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,
  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

async function testDatabaseAccess() {
  console.log('üîç Testando acesso ao Firebase...');
  
  try {
    // 1. Testar acesso √†s cole√ß√µes
    console.log('\nüìä Verificando cole√ß√µes dispon√≠veis...');
    
    // Testar cole√ß√£o de tickets
    const ticketsSnapshot = await getDocs(collection(db, 'tickets'));
    console.log(`‚úÖ Tickets encontrados: ${ticketsSnapshot.size}`);
    
    if (ticketsSnapshot.size > 0) {
      console.log('\nüìã Primeiros 3 tickets:');
      let count = 0;
      ticketsSnapshot.forEach((doc) => {
        if (count < 3) {
          const data = doc.data();
          console.log(`  - ID: ${doc.id}`);
          console.log(`    RemoteJid: ${data.remoteJid}`);
          console.log(`    Instance: ${data.instanceName}`);
          console.log(`    Status: ${data.status}`);
          console.log(`    Cliente: ${data.client?.name || 'N/A'}`);
          console.log(`    √öltima mensagem: ${data.lastMessage || 'N/A'}`);
          console.log('    ---');
          count++;
        }
      });
    }
    
    // Testar cole√ß√£o de mensagens
    const messagesSnapshot = await getDocs(collection(db, 'messages'));
    console.log(`\nüí¨ Mensagens encontradas: ${messagesSnapshot.size}`);
    
    if (messagesSnapshot.size > 0) {
      console.log('\nüìù Primeiras 5 mensagens:');
      let count = 0;
      messagesSnapshot.forEach((doc) => {
        if (count < 5) {
          const data = doc.data();
          console.log(`  - ID: ${doc.id}`);
          console.log(`    RemoteJid: ${data.remoteJid}`);
          console.log(`    Instance: ${data.instanceName}`);
          console.log(`    Sender: ${data.sender}`);
          console.log(`    Content: ${data.content?.substring(0, 50)}...`);
          console.log(`    Type: ${data.type}`);
          console.log(`    Timestamp: ${data.timestamp?.toDate?.() || data.timestamp}`);
          console.log('    ---');
          count++;
        }
      });
    }
    
    // 3. Testar consulta espec√≠fica de mensagens por ticket
    if (ticketsSnapshot.size > 0) {
      const firstTicket = ticketsSnapshot.docs[0].data();
      console.log(`\nüîç Testando consulta de mensagens para ticket: ${firstTicket.remoteJid}`);
      
      const messagesQuery = query(
        collection(db, 'messages'),
        where('remoteJid', '==', firstTicket.remoteJid),
        where('instanceName', '==', firstTicket.instanceName)
      );
      
      const ticketMessages = await getDocs(messagesQuery);
      console.log(`üì® Mensagens encontradas para este ticket: ${ticketMessages.size}`);
      
      if (ticketMessages.size > 0) {
        console.log('\nüìã Mensagens do ticket:');
        ticketMessages.forEach((doc) => {
          const data = doc.data();
          console.log(`  - ${data.sender}: ${data.content?.substring(0, 100)}...`);
          console.log(`    Timestamp: ${data.timestamp?.toDate?.() || data.timestamp}`);
        });
      } else {
        console.log('‚ùå Nenhuma mensagem encontrada para este ticket espec√≠fico');
        console.log('   Isso pode indicar um problema na consulta ou nos dados');
      }
    }
    
    // 4. Verificar inst√¢ncias dispon√≠veis
    const instancesSnapshot = await getDocs(collection(db, 'instances'));
    console.log(`\nüè¢ Inst√¢ncias encontradas: ${instancesSnapshot.size}`);
    
    if (instancesSnapshot.size > 0) {
      console.log('\nüìã Inst√¢ncias dispon√≠veis:');
      instancesSnapshot.forEach((doc) => {
        const data = doc.data();
        console.log(`  - ${doc.id}: ${data.name || 'N/A'} (${data.status || 'N/A'})`);
      });
    }
    
    // 5. Verificar √≠ndices e performance
    console.log('\n‚ö° Testando performance de consultas...');
    const start = Date.now();
    
    const limitedQuery = query(
      collection(db, 'messages'),
      limit(10)
    );
    
    await getDocs(limitedQuery);
    const end = Date.now();
    console.log(`‚è±Ô∏è Consulta com limit(10) levou: ${end - start}ms`);
    
    if (end - start > 5000) {
      console.log('‚ö†Ô∏è AVISO: Consulta muito lenta, pode indicar problema de √≠ndices');
    }
    
  } catch (error) {
    console.error('‚ùå Erro ao acessar Firebase:', error);
    
    if (error.code) {
      console.error(`C√≥digo do erro: ${error.code}`);
    }
    
    if (error.message) {
      console.error(`Mensagem: ${error.message}`);
    }
    
    // Sugest√µes baseadas no tipo de erro
    if (error.code === 'permission-denied') {
      console.log('\nüí° Sugest√µes:');
      console.log('   1. Verificar regras do Firestore');
      console.log('   2. Verificar autentica√ß√£o');
      console.log('   3. Verificar configura√ß√£o do projeto');
    } else if (error.code === 'unavailable') {
      console.log('\nüí° Sugest√µes:');
      console.log('   1. Verificar conex√£o com internet');
      console.log('   2. Verificar status do Firebase');
      console.log('   3. Tentar novamente em alguns minutos');
    }
  }
}

// Executar teste
testDatabaseAccess().then(() => {
  console.log('\n‚úÖ Teste conclu√≠do');
  process.exit(0);
}).catch((error) => {
  console.error('‚ùå Erro fatal:', error);
  process.exit(1);
});